name: bazar-authorization

on:
  push:
    branches:
      - "release/**"
      - "master"
  pull_request:
    branches:
      - "dev"
      - "master"
  workflow_dispatch:
permissions:
  contents: write

env:
  SERVICE_CONTEXT: ./
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/bazar-authorization

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04
    
    steps:
      # ======================================================
      # STEP 0: Checkout Code (CRITICAL - WAS MISSING)
      # ======================================================
      - name: Checkout Code
        uses: actions/checkout@v4
      # ======================================================
      # STEP 1: Setup GraalVM Environment<!--citation:5-->
      # Optimization: Switched to Java 21 (LTS) for stability
      # ======================================================
      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '25'      # Recommended: LTS version
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'gradle'

      - name: Extract Version
        id: get_version
        working-directory: ${{ env.SERVICE_CONTEXT }}
        run: |
          chmod +x gradlew
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"

      # ======================================================
      # STEP 2: Compile Native Image (On Runner)
      # ======================================================
      - name: Build Native Image
        working-directory: ${{ env.SERVICE_CONTEXT }}
        run: |
          ./gradlew processTestAot nativeCompile 

      # ======================================================
      # STEP 3: Docker Setup
      # ======================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        # LOGIC: Only login if this is a 'release' branch push
        if: startsWith(github.ref, 'refs/heads/master')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ======================================================
      # STEP 4: Build & Push (Conditional)
      # ======================================================
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.SERVICE_CONTEXT }}
          file: ${{ env.SERVICE_CONTEXT }}/Dockerfile
          # LOGIC: Push only on master branches. Otherwise, just load/test.
          push: ${{ startsWith(github.ref, 'refs/heads/master') }}
          load: ${{ !startsWith(github.ref, 'refs/heads/master') }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.APP_VERSION }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      # ======================================================
      # STEP 5: Create or Move Git Tag (On Merge to Master)
      # ======================================================
      - name: Create or Update Git Tag
        if: github.ref == 'refs/heads/master'
        run: |
          TAG_NAME="bauth-${{ env.APP_VERSION }}"

          # Configure git user (required for tagging)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Force updating tag $TAG_NAME to point to current commit..."

          # -f: Force (overwrite if exists)
          # -a: Annotated tag (stores history/message)
          git tag -fa "$TAG_NAME" -m "Auto-tag release $TAG_NAME"

          # Push with --force to update the remote tag
          git push origin -f "$TAG_NAME"